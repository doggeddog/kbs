<html>

<head>
	<meta http-equiv="Content-Type" content="text/html; charset=gb2312">
	<title>wForum 文档</title>
	<link rel="stylesheet" href="wForum.css" type="text/css">
	<meta name="generator" content="DocBook XSL Stylesheets V1.69.1">
	<!--
    #######################################################################
    # THIS HTML FILE IS GENERATED FROM XML SOURCE. DO NOT EDIT THIS FILE! #
    #######################################################################
-->
</head>

<body bgcolor="white" text="black" link="#0000FF" vlink="#840084" alink="#0000FF">
	<div class="article" lang="zh-cn">
		<div class="titlepage">
			<div>
				<div>
					<h2 class="title">
						<a name="maintitle"></a>wForum 文档
					</h2>
				</div>
			</div>
			<hr>
		</div>
		<div class="toc">
			<p><b>目录</b></p>
			<dl>
				<dt><span class="section"><a href="#intro">1. wForum 简介</a></span></dt>
				<dd>
					<dl>
						<dt><span class="section"><a href="#intro_copyright">1.1. 版权声明</a></span></dt>
					</dl>
				</dd>
				<dt><span class="section"><a href="#install">2. wForum 安装说明</a></span></dt>
				<dd>
					<dl>
						<dt><span class="section"><a href="#install_kbsbbs">2.1. kbsbbs 安装</a></span></dt>
						<dt><span class="section"><a href="#install_wforum">2.2. 安装 wForum</a></span></dt>
						<dd>
							<dl>
								<dt><span class="section"><a href="#feature_notes">2.2.1. default.php
											内部分参数的附加说明</a></span></dt>
							</dl>
						</dd>
						<dt><span class="section"><a href="#install_uploadface">2.3. 自定义头像功能</a></span></dt>
						<dt><span class="section"><a href="#install_mysql">2.4. 加入 mysql 支持和小字报功能</a></span></dt>
						<dt><span class="section"><a href="#install_tex2mathml">2.5. 加入 itex2mathml 支持</a></span></dt>
						<dt><span class="section"><a href="#install_append">2.6. 附加说明</a></span></dt>
						<dt><span class="section"><a href="#bbs2www">2.7. wForum 和 kbsbbs 的 web 界面配合</a></span></dt>
					</dl>
				</dd>
				<dt><span class="section"><a href="#tech_details">3. 技术细节</a></span></dt>
				<dd>
					<dl>
						<dt><span class="section"><a href="#javascript">3.1. Javascript 方面的一些说明</a></span></dt>
						<dt><span class="section"><a href="#thread_notes">3.2. wForum 对文章列表部分的处理</a></span></dt>
						<dd>
							<dl>
								<dt><span class="section"><a href="#prev_next_thread">3.2.1.
											文章阅读界面跳转到上一主题/下一主题的实现</a></span></dt>
								<dt><span class="section"><a href="#thread_notes_1">3.2.2. 关于同主题模式的利弊</a></span></dt>
							</dl>
						</dd>
						<dt><span class="section"><a href="#reply_tree">3.3. 关于树形回复结构</a></span></dt>
						<dt><span class="section"><a href="#section_list">3.4. 分区版面列表</a></span></dt>
						<dt><span class="section"><a href="#funcs_php">3.5. inc/funcs.php 代码分析</a></span></dt>
						<dt><span class="section"><a href="#itex2mathml_details">3.6. itex2mathml 的一些技术细节</a></span>
						</dt>
						<dt><span class="section"><a href="#browscap">3.7. USEBROWSCAP 站点参数（这个功能目前关闭）</a></span></dt>
						<dt><span class="section"><a href="#bbsleft">3.8. wForum 框架结构支持</a></span></dt>
						<dt><span class="section"><a href="#misc">3.9. 一些杂事</a></span></dt>
					</dl>
				</dd>
			</dl>
		</div>
		<div class="section" lang="zh-cn">
			<div class="titlepage">
				<div>
					<div>
						<h2 class="title" style="clear: both">
							<a name="intro"></a>1.&#160;wForum 简介
						</h2>
					</div>
				</div>
			</div>
			<div class="itemizedlist">
				<ul type="disc">
					<li>wForum 是基于高性能的 KBS 系统源码（一万五千人同时在线）的高性能论坛系统；</li>
					<li>主页：<a href="http://wforum.aka.cn/" target="_blank">http://wforum.aka.cn/</a>；</li>
					<li>推荐使用 linux 系统 (redhat)；</li>
					<li>讨论区：<a href="http://wforum.zixia.net/board.php?name=wForum"
							target="_blank">http://wforum.zixia.net/board.php?name=wForum</a>
					</li>
				</ul>
			</div>
			<div class="section" lang="zh-cn">
				<div class="titlepage">
					<div>
						<div>
							<h3 class="title">
								<a name="intro_copyright"></a>1.1.&#160;版权声明
							</h3>
						</div>
					</div>
				</div>
				<div class="itemizedlist">
					<ul type="disc">
						<li>这份软件基于 GPL 版本发布。请参考 COPYING.GPL 文件。任何对本软件代码的修改需要同样遵循 GPL 许可。</li>
						<li>版权归属 北京阿卡信息技术有限公司 和 <a href="http://dev.kcn.cn/" target="_blank">KBS 开发组</a>共同所有。</li>
						<li>额外声明：未经北京阿卡公司书面许可，不允许将本软件作商业应用。</li>
					</ul>
				</div>
			</div>
		</div>
		<div class="section" lang="zh-cn">
			<div class="titlepage">
				<div>
					<div>
						<h2 class="title" style="clear: both">
							<a name="install"></a>2.&#160;wForum 安装说明
						</h2>
					</div>
				</div>
			</div>
			<p>首先到 <a href="http://dev.kcn.cn/" target="_blank">KBS 开发组主页</a> 下载最新的 kbs 和 wForum 代码。请一定注意 wForum
				必须配合同一个时间点 kbs 的 CVS 主分支或者其打包 snapshot 版本使用，比如下载同一天的 kbsbbs-snapshot 和 wForum-snapshot 就不会有问题，如果最新
				wForum snapshot 配合 kbsbbs 1.2.x 使用就会有这样那样的小问题。另外，wForum 需要 PHP 支持 gd、dom。</p>
			<div class="section" lang="zh-cn">
				<div class="titlepage">
					<div>
						<div>
							<h3 class="title">
								<a name="install_kbsbbs"></a>2.1.&#160;kbsbbs 安装
							</h3>
						</div>
					</div>
				</div>
				<p>kbsbbs 安装请参考其安装文档；必须打开 WWW 支持。站点文件请参考 site/zixia.h 和 site/zixia.c。</p>
				<p>原先安装了 kbsbbs 系统的站点需要确认 site.h 里面定义了</p>
				<pre class="programlisting">#define HAVE_WFORUM 1</pre>
				<p>，如果没有定义，加上之后重新编译安装所有的程序并重新启动 web。</p>
			</div>
			<div class="section" lang="zh-cn">
				<div class="titlepage">
					<div>
						<div>
							<h3 class="title">
								<a name="install_wforum"></a>2.2.&#160;安装 wForum
							</h3>
						</div>
					</div>
				</div>
				<p>解压 wForum 到 web 根目录下面的 wForum 目录。给你的站点取个名字，比方叫 kcn。进入 wForum 目录，执行下面几个命令：
				</p>
				<pre class="programlisting">
cp inc/sites/site-example.php inc/sites/kcn.php
ln -s sites/kcn.php inc/wForum.site.php</pre>
				<p>
					inc/wForum.site.php 就是你的站点定义文件。请注意，inc/wForum.site.php 必须是一个指向 inc/sites/
					目录下某个文件的符号连接，否则程序会找不到系统默认参数配置文件 default.php。修改 inc/wForum.site.php
					里面的各类参数，特别是分类讨论区。另外，inc/reg_txt.php 是注册用户的时候看到的网站协议，可以换成站点站规。
				</p>
				<div class="section" lang="zh-cn">
					<div class="titlepage">
						<div>
							<div>
								<h4 class="title">
									<a name="feature_notes"></a>2.2.1.&#160;default.php 内部分参数的附加说明
								</h4>
							</div>
						</div>
					</div>
					<p>inc/sites/default.php 列举了可以在 inc/wForum.site.php 里定义的参数。大多数参数说明已经足够明确，下面对个别参数作附加说明。
					</p>
					<div class="itemizedlist">
						<ul type="disc">
							<li>
								<p>$SiteURL: 这个变量用于一些需要输出绝对路径的地方，应该定义为 wForum 安装的根的 URL，最后一个字符必须是 '/'。</p>
							</li>
							<li>
								<p>MAINTITLE: 站点标题可以包含 html，打开 mathml 支持的站点千万注意 html 必须符合 xhtml 标准。</p>
							</li>
							<li>
								<p>ONBOARD_USERS: 光打开这个参数只能让有 SYSOP 权限的用户看到版面在线名单，如果想让普通用户也看到，还需要在 src/site.h 内定义：</p>
								<pre class="programlisting">#define ALLOW_PUBLIC_USERONBOARD 1</pre>
								<p>对于访问量大但没有安装 squid 的站点，不建议开启这个功能。</p>
							</li>
						</ul>
					</div>
					<p>
					</p>
				</div>
			</div>
			<div class="section" lang="zh-cn">
				<div class="titlepage">
					<div>
						<div>
							<h3 class="title">
								<a name="install_uploadface"></a>2.3.&#160;自定义头像功能
							</h3>
						</div>
					</div>
				</div>
				<p>如果开启自定义头像功能，确认一下 wForum 主目录下面有 uploadFace/ 目录，如果没有的话就建立一下。注意这个目录必须是 httpd 运行身份的用户（一般建议用 bbs 用户）可写的。
				</p>
				<div class="note" style="margin-left: 0.5in; margin-right: 0.5in;">
					<h3 class="title">自定义头像的更多细节</h3>
					<p>自定义头像的存放位置是 wForum 主目录下面的 uploadFace/ 目录。在备份和转移 BBS 数据的时候也要备份这个目录。有人可能会希望 BBS 的数据全部都在 ~bbs/
						目录下面以方便备份，这是可行的。下面提供一个方法：
					</p>
					<div class="orderedlist">
						<ol type="1">
							<li>
								<p>在 ~bbs/ 目录下建立 uploadFace 目录。</p>
							</li>
							<li>
								<p>在 wForum 主目录下面删除 uploadFace 目录，并且建立一个符号连接：
								</p>
								<pre class="programlisting">ln -s ~bbs/uploadFace uploadFace</pre>
								<p>
								</p>
							</li>
							<li>
								<p>确认在 httpd.conf 中，wForum主目录允许 FollowSymLinks，例如如下：
								</p>
								<pre class="programlisting">
&lt;Directory "/var/www/html/wForum"&gt;
    Options FollowSymLinks
&lt;/Directory&gt;</pre>
								<p>
									具体的细节请参考 apache 的配置说明。注意：允许 FollowSymLinks 会有潜在的安全问题。
								</p>
							</li>
						</ol>
					</div>
					<p>
					</p>
				</div>
			</div>
			<div class="section" lang="zh-cn">
				<div class="titlepage">
					<div>
						<div>
							<h3 class="title">
								<a name="install_mysql"></a>2.4.&#160;加入 mysql 支持和小字报功能
							</h3>
						</div>
					</div>
				</div>
				<p>目前 wForum 的 mysql 支持仅用于版面的小字报功能，默认是关闭的。正确加入 mysql 支持之后小字报功能就会自动打开。mysql 支持首先要求 PHP 支持 mysql。在
					wForum.site.php 加入：</p>
				<pre class="programlisting">define("DB_ENABLED", true);</pre>
				<p>以打开 mysql 支持，同时配置 mysql 用户、密码和数据库名。用如下语句在 mysql 中建立一个数据表来支持小字报功能：
				</p>
				<pre class="programlisting">
create table smallpaper_tb(
 ID int    not null auto_increment primary key,
 boardID   int not null,
 Owner     varchar(14) not null,
 Title     varchar(100) not null,
 Content   mediumtext   not null,
 Hits      int not null,
 Addtime   datetime not null
);</pre>
				<p>
					如果安装或者配置不正确，可能导致版面文章列表的页面出错。如果出错，可以使用 SYSOP 权限的用户登录之后打开 admin.check_mysql.php 页面判断可能的错误。</p>
			</div>
			<div class="section" lang="zh-cn">
				<div class="titlepage">
					<div>
						<div>
							<h3 class="title">
								<a name="install_tex2mathml"></a>2.5.&#160;加入 itex2mathml 支持
							</h3>
						</div>
					</div>
				</div>
				<p>现在 wForum 支持 itex（数学公式排版语言 tex 的一种衍生形式） 到 mathml （浏览器显示数学公式的推荐标准）的自动转化。这部分功能参考 ythtbbs 系统完成，部分使用
					ythtbbs 代码的站点有这个功能的介绍可以参考，比如 <a href="http://bbs.qxntc.edu.cn/" target="_blank">笔山书院 BBS</a> web
					下的用户帮助里面就有。</p>
				<p>wForum 支持 itex2mathml 对客户端和服务器端都有要求。客户端的要求是最新版的 Mozilla Firefox，Netscape 等支持 MathML 的浏览器。如果是 MSIE
					浏览器的话，必须是 5.5 版以上，而且需要预装 <a href="http://www.dessci.com/en/products/mathplayer/download.htm"
						target="_blank">MathPlayer 2.0</a> 插件，wForum 不会提示用户安装。服务器端要求 <a
						href="http://pear.math.pitt.edu/mathzilla/itex2mml.html" target="_blank">itex2mml</a> 转换程序，请下载后将
					itex2MML 可执行文件放在 ~bbs/bin/ 目录下面，并且在 wForum.site.php 里面加入：</p>
				<pre class="programlisting">define("SUPPORT_TEX", true);</pre>
				<p>用户发表需要 itex2mathml 支持的帖子的时候要选择“使用 tex 发表”选项。关于 itex2mml 支持的 tex
					格式可以在其主页上找到文档。目前这部分功能还有很多问题，但是基本功能已经可以使用。具体的技术细节可以参考下面的 <a href="#itex2mathml_details">itex2mathml
						的一些技术细节</a>。</p>
			</div>
			<div class="section" lang="zh-cn">
				<div class="titlepage">
					<div>
						<div>
							<h3 class="title">
								<a name="install_append"></a>2.6.&#160;附加说明
							</h3>
						</div>
					</div>
				</div>
				<div class="orderedlist">
					<ol type="1">
						<li>
							<p>httpd.conf 最好设置 wForum 所在的目录 index.php 也是 DirectoryIndex。可以在 httpd.conf 里面设置
							</p>
							<pre class="programlisting">DirectoryIndex index.html index.html.var index.php</pre>
							<p>
							</p>
						</li>
						<li>
							<p>php.ini 要关掉自动给引号加前导反斜杠，并且禁止 PHP 代码开始标志的缩写形式：
							</p>
							<pre class="programlisting">
magic_quotes_gpc = off
short_open_tag = off</pre>
							<p>
								对于服务器前端没有 squid 加速的站点，建议在 php.ini 内设置：</p>
							<pre class="programlisting">output_buffering = 65536</pre>
							<p>这个设置的作用是强制让 PHP 缓存页面输出，对于慢网速，大页面的输出，脚本执行可能会有很大一部分时间用于网络 I/O 的等待上，打开 output_buffering
								可以有效地提高页面执行的效率，加强服务器的响应能力，但可能会稍稍增加一些服务器的负荷。
							</p>
						</li>
						<li>
							<p>要保证 wForum 下的未读记录正常工作，你的 site.h 必须设置
							</p>
							<pre class="programlisting">
#define USE_TMPFS   1       /*使用内存文件系统加速*/
#define TMPFSROOT   "cache" /*tmpfs的根在bbshome/cache */</pre>
							<p>
								如果 USE_TMPFS 原来是 0，修改后重新编译安装。同时在 ~bbs/ 下建立 cache 目录，重启动服务。可以在 ~bbs/cache/ mount 一个 tmpfs
								文件系统提高性能。推荐 USE_TMPFS 定义成 1，否则的话两个 telnet 登录之间的未读记录都不会同步。
							</p>
						</li>
						<li>
							<p>PHP 编译说明: wForum 需要 PHP 支持 gd、dom 及 mysql。如果你是自己编译 PHP，首先，确认你的 linux 系统已安装了
								mysql、gd、libjpeg、libpng、freetype、libxml2 及各自相应的 devel 包，然后用下面的参数编译 PHP（假设 apache 1.3.x）：
							</p>
							<pre class="programlisting">
./configure  --prefix=/bbs/www --with-freetype-dir=/usr/lib --with-gd
 --with-jpeg-dir --with-png-dir --with-config-file-path=/bbs/www/conf
 --with-zlib-dir --with-mysql --with-apxs=/bbs/www/bin/apxs --with-dom</pre>
							<p>
							</p>
						</li>
						<li>
							<p>如果使用 apache2 需要注意的地方：
							</p>
							<div class="itemizedlist">
								<ul type="disc">
									<li>
										<p>php configure 命令中 --with-apxs 改成 --with-apxs2</p>
									</li>
									<li>
										<p>httpd.conf 建议加入 AddDefaultCharset gb2312</p>
									</li>
								</ul>
							</div>
							<p>
							</p>
						</li>
						<li>
							<p>wForum 系统会自动显示每封信件的大小，但是如果是从 2004 年 8 月以前的系统升级，以前旧的信件的大小需要用 local_utl/sync_mailsize
								程序同步一下。这个程序加 -a 参数就会同步所有的信件大小。</p>
						</li>
						<li>
							<p>如果 wForum 是从 2004 年 6 月以前的代码升级的，推荐升级之后删除 ~bbs/boards/ 目录下所有的 .WEBTHREAD 强制让系统重新生成索引。可以在
								~bbs/boards/ 下执行这样一个命令：
							</p>
							<pre
								class="programlisting">ls -d1 * | awk '{system(sprintf("rm %s/.WEBTHREAD", $1));}'</pre>
							<p>
							</p>
						</li>
					</ol>
				</div>
			</div>
			<div class="section" lang="zh-cn">
				<div class="titlepage">
					<div>
						<div>
							<h3 class="title">
								<a name="bbs2www"></a>2.7.&#160;wForum 和 kbsbbs 的 web 界面配合
							</h3>
						</div>
					</div>
				</div>
				<p>wForum 和 kbsbbs 源代码 bbs2www/html/ 下那个 web 界面可以配合使用，互为补充。特别说明的两点是：第一，bbs2www/html/bbslogin.php 和
					wForum/logon.php 所接受的登录表单格式是完全兼容的，所以可以在 web 首页放一个 checkbox，用同一个用户名/密码输入表单就可以让用户选择是登录到哪一个 web
					界面。第二，两个 web 界面允许共享登录 cookie，这样可以在两个界面之间跳转而不必重新登录（可以在两个界面适当的地方加跳转链接）。要实现这个功能需要将两个 web
					界面装在同一个域名下，wForum 可以放在 web 主目录的 wForum/ 目录下，然后在 wForum 的 inc/wForum.site.php 中定义：</p>
				<pre class="programlisting">
define('COOKIE_PREFIX', '');
define('COOKIE_PATH', '/');
</pre>
				<p>
					如果两个 web 界面在同一个域名下的不同子域名，共享 cookie 还是可能的。wForum 留出了定义 COOKIE_DOMAIN 常量的接口，如果配置 COOKIE_DOMAIN
					常量请一定完全搞明白这样做可能带来的安全问题。
				</p>
			</div>
		</div>
		<div class="section" lang="zh-cn">
			<div class="titlepage">
				<div>
					<div>
						<h2 class="title" style="clear: both">
							<a name="tech_details"></a>3.&#160;技术细节
						</h2>
					</div>
				</div>
			</div>
			<div class="section" lang="zh-cn">
				<div class="titlepage">
					<div>
						<div>
							<h3 class="title">
								<a name="javascript"></a>3.1.&#160;Javascript 方面的一些说明
							</h3>
						</div>
					</div>
				</div>
				<div class="orderedlist">
					<ol type="1">
						<li>
							<p>mozilla 对 class、ID 等属性是大小写敏感的；而 IE 是大小写不敏感的。在设置和应用样式单时要注意 class 的大小写。</p>
						</li>
						<li>
							<p>browser.js 文件主要函数、变量及功能:
							</p>
							<div class="glosslist">
								<dl>
									<dt>变量: isIE</dt>
									<dd>
										<p>浏览器是否是 IE</p>
									</dd>
									<dt>变量: isW3C</dt>
									<dd>
										<p>浏览器是否兼容 W3C 标准。如果浏览器支持 W3C 标准，以下函数将会优先使用 W3C 标准函数。</p>
									</dd>
									<dt>函数：getRawObject(obj)</dt>
									<dd>
										<p>获取ID为obj的对象。例:
										</p>
										<pre class="programlisting">
.....
&lt;input type="button" name="clickIt" id="clickIt" value="I'm button"&gt;
.....
&lt;script language="javascript"&gt;
...
oButton = getRawObject("clickIt");
oButton.value = "I'm new button";
...
&lt;/script&gt;
.....</pre>
										<p>
										</p>
									</dd>
									<dt>函数：getParentRawObject(obj)</dt>
									<dd>
										<p>用于子frame;获取父窗口中ID为obj的对象。</p>
									</dd>
									<dt>函数：getRawObjectFrom(obj,oFrame)</dt>
									<dd>
										<p>从oFrame中获取ID为obj的对象。</p>
									</dd>
									<dt>函数: getObjectCollection(obj)</dt>
									<dd>
										<p>获取ID/Name为obj的一组对象。例:
										</p>
										<pre class="programlisting">
.....
&lt;input type="checkbox" name="checkMe" id="checkMe" value="0"&gt;checkbox0
&lt;input type="checkbox" name="checkMe" id="checkMe" value="1"&gt;checkbox1
&lt;input type="checkbox" name="checkMe" id="checkMe" value="2"&gt;checkbox2
.....
&lt;script language="javascript"&gt;
...
oCheckboxs = getObjectCollection("CheckMe");
for (i = 0; i &lt; oCheckboxs.length; i++) {
	alert(oCheckbox[i].value);
}
...
&lt;/script&gt;
.....</pre>
										<p>
										</p>
									</dd>
									<dt>函数: getParentObjectCollection(obj)</dt>
									<dd>
										<p>获取父窗口ID/Name为obj的一组对象。</p>
									</dd>
									<dt>函数: getObjectCollectionFrom(obj,oFrame)</dt>
									<dd>
										<p>从oFrame中获取ID/Name为obj的一组对象。</p>
									</dd>
									<dt>函数: getObjectStyle(obj)</dt>
									<dd>
										<p>获取ID为obj的对象的style。例:
										</p>
										<pre class="programlisting">
menuDivStyle = getObjectStyle("menuDiv");
menuDivStyle.visible = "hidden";</pre>
										<p>
										</p>
									</dd>
									<dt>函数: shiftTo(obj, x, y)</dt>
									<dd>
										<p>将ID为obj的对象移动到坐标(x,y)。例:
										</p>
										<pre class="programlisting">shiftTo("menuDiv",0,0);</pre>
										<p>
										</p>
									</dd>
									<dt>函数: shiftBy(obj, deltaX, deltaY)</dt>
									<dd>
										<p>将ID为obj的对象移动(deltaX,deltaY)。</p>
									</dd>
									<dt>函数: setZIndex(obj, zOrder)</dt>
									<dd>
										<p>将ID为obj的对象的zIndex值设为zOrder。</p>
									</dd>
									<dt>函数: hide(obj) show(obj)</dt>
									<dd>
										<p>隐藏/显示ID为obj的对象。</p>
									</dd>
									<dt>函数: getObjectLeft(obj) getObjectTop(obj) getObjectWidth(obj)
										getObjectHeight(obj)</dt>
									<dd>
										<p>获取ID为obj的对象的坐标和长宽等。</p>
									</dd>
								</dl>
							</div>
							<p>
							</p>
						</li>
						<li>
							<p>目前 wForum 的 javascript 事件处理比较混乱，不同的 .js 文件都会设置全局的事件监听。比方，inc/floater.js 里面设置了 onmouseup
								onmousedown onmousemove 事件监听，inc/funcs.js 则会设置 onmouseover，而页面头也带有 &lt;body ...
								onmouseover="HideMenu(event);"&gt;。这些在以后开发中如果不注意，很容易产生冲突。现在这部分标准尚未统一，所以只在 inc/funcs.js
								写了一个变通处理多个监听 window.onload 事件的方法作示范，别的地方切莫再自己设置 window.onload 事件监听，只需调用下列函数。
							</p>
							<div class="glosslist">
								<dl>
									<dt>函数: addOnLoadListener(listener)</dt>
									<dd>
										<p>添加 window.onload 事件监听的语句，listener 是一个字符串，是具体的 javascript 代码，而不是函数指针。</p>
									</dd>
									<dt>函数: registerFocusOnLoad(ele)</dt>
									<dd>
										<p>将 id 为 ele 的元素注册成页面载入完毕时设置的焦点元素。注意 ele 是字符串，不是具体控件的引用。</p>
									</dd>
								</dl>
							</div>
							<p>
							</p>
						</li>
					</ol>
				</div>
			</div>
			<div class="section" lang="zh-cn">
				<div class="titlepage">
					<div>
						<div>
							<h3 class="title">
								<a name="thread_notes"></a>3.2.&#160;wForum 对文章列表部分的处理
							</h3>
						</div>
					</div>
				</div>
				<p>现在的 wForum 文章列表是基于同主题的，列表时只列出同主题首篇文章；列表按照同主题最后一篇文章的发文时间降序排序，有分页功能。这部分处理主要由 phpbbslib.c 中的下面几个函数来完成：
				</p>
				<div class="glosslist">
					<dl>
						<dt>bbs_getthreadnum(string boardName)</dt>
						<dd>
							<p>该函数求某版面下的主题数量。这个函数首先比较 .DIR 和 .WEBTHREAD 文件的时间戳，如果 .WEBTHREAD 旧于 .DIR 则调用 bbslib.c
								中的www_generateOriginIndex() 函数重新生成 .WEBTHREAD 文件（似乎需要一个更好的判断方式来触发更新 .WEBTHREAD），然后直接由
								.WEBTHREAD 的文件长度求记录数目。</p>
							<p>其主要算法是：首先建立一标志数组，在其中存放已找到的groupID。这个标志数组有两个内部数据结构：第一个是链表，按照每个主题最后发文时间排序，最后可以直接顺序写入
								.WEBTHREAD。另一个结构是平衡二叉树，目的是方便快速搜索 groupID。程序倒序遍历 .DIR 中的记录，如果其 groupID
								不在标志数组中，则加入标志数组。在遍历过程中同时判断该帖子是否是原文，如果是，同时需要将原文信息复制进标志数组。最后生成 .WEBTHREAD
								的时候是按照链表顺序写，判断该主题是否有原文，如果没有，作一些特殊处理再写入 .WEBTHREAD 以便到时候显示原文是否被删除。关于这里是否有原文的处理细节，参见代码。
							</p>
						</dd>
						<dt>bbs_getthreads(string boardName, int start, int num)</dt>
						<dd>
							<p>该函数按同主题最后一篇文章的发文时间降序排列，取从 start 开始的 num 篇主题信息。这个函数充分利用已经产生的 .WEBTHREAD 文件来操作。</p>
						</dd>
					</dl>
				</div>
				<div class="section" lang="zh-cn">
					<div class="titlepage">
						<div>
							<div>
								<h4 class="title">
									<a name="prev_next_thread"></a>3.2.1.&#160;文章阅读界面跳转到上一主题/下一主题的实现
								</h4>
							</div>
						</div>
					</div>
					<p>基本思路：大部分文章阅读链接加入 pos 参数指示该主题在 .WEBTHREADS 索引中的位置，页面内上/下主题的链接同时带入 groupID 参数指示当前贴子的
						groupID。处理上/下主题跳转的脚本用 groupID 验证 pos 位置的主题是否还仍旧是这个主题，如果不是的话说明版面索引发生变化，直接返回错误，并提示返回版面；否则就从位置 pos
						+/- 1 取出上/下主题 groupID。当主题索引发生变化时原则上可以在 .WEBTHREADS
						中线性查找重新定位，但返回错误的原因是因为此时（按照最后回复顺序排列的）上/下主题的意义可能已经发生变化，</p>
					<p>两个问题：1、php 脚本内多次调用 bbs 库函数，中间有时间差，原则上有漏洞，但，可能性不大；2、可能出现 pos 位置 groupID 没有变但版面索引 .WEBTHREADS
						已经发生变化的情况，可能性不大。</p>
				</div>
				<div class="section" lang="zh-cn">
					<div class="titlepage">
						<div>
							<div>
								<h4 class="title">
									<a name="thread_notes_1"></a>3.2.2.&#160;关于同主题模式的利弊
								</h4>
							</div>
						</div>
					</div>
					<p>同主题模式和公网论坛比较一致但是和传统 telnet 配合的时候可能会有不一致的地方。以下几个问题是特别需要注意的：
					</p>
					<div class="itemizedlist">
						<ul type="disc">
							<li>
								<p>删除了原文的置顶不能阅读；</p>
							</li>
							<li>
								<p>一个主题是否显示成精华，不可re，and/or
									置顶仅仅是判断原文是否有这个属性。特别的，如果一个re文被g，这个主题不会自动成为精华贴。类似的，一片re文被设置为不可re，这个主题不会显示为不可re；但是如果原文被设置成不可re，这个主题会显示为不可re(当然这个标志只有版主能看见)不过所有已有的re文还都是可re的。这里还有不少细节问题。
								</p>
							</li>
						</ul>
					</div>
					<p>
						这个以后可能会改。
					</p>
				</div>
			</div>
			<div class="section" lang="zh-cn">
				<div class="titlepage">
					<div>
						<div>
							<h3 class="title">
								<a name="reply_tree"></a>3.3.&#160;关于树形回复结构
							</h3>
						</div>
					</div>
				</div>
				<p>loadtree.php (版面文章列表点击 + 会显示回复结构) 和 disparticle.php (单篇文章阅读底部会显示回复结构) 已经加入了树形回复结构的支持。基础代码在
					inc/treeview.inc.php 里面。产生回复树结构再递归显示其实是一件比较耗时间的操作，这部分代码以后可能还需要再优化。现在如果回复超过一定的数量(默认 51，可以在
					wForum.site.php 里面配置)，就不显示回复树结构而直接显示平板式回复结构。另外，kbsbbs 现在设置的一个主题可以返回的最大回复数量是
					512。这里其实还是有文章可做，比方回复树里面显示每一个帖子是否已读，不过暂时先不考虑了。</p>
				<p>default.php 里面定义了 SHOWREPLYTREE，如果为 1 就会支持树形回复结构。如果为 0 就是平级显示所有回复。这里也有文章可做，SHOWREPLYTREE
					其实定义成用户自定义参数或者 cookie 参数可能更好。</p>
			</div>
			<div class="section" lang="zh-cn">
				<div class="titlepage">
					<div>
						<div>
							<h3 class="title">
								<a name="section_list"></a>3.4.&#160;分区版面列表
							</h3>
						</div>
					</div>
				</div>
				<p>分区版面列表采用 JS 写页面。展开列表可能需要隐藏 iframe 读数据，折叠列表直接使用已有的 js 变量重写页面。列表是否展开由一个 ShowSecBoards cookie 控制。这个
					cookie 变量的最低一个 bit 表示收藏夹版面列表是否展开，第(i+1) bit 表示第 i 个分区是否展开。二级目录永远展开。</p>
				<p>列表也可以完全隐藏。这个由 HideSecBoards cookie 控制。LSB 没有作用。第 (i+1) bit 表示第 i 个分区的版面是否完全隐藏。收藏夹不可以被隐藏。</p>
				<p>这两个 cookie 全部由客户端设置，服务器端只读取（除了特殊情况设置初始值）。这两个 cookie 的默认值：ShowSecBoards 是 0，HideSecBoards 可配置为 0 或者
					~0。</p>
				<p>JavaScript 变量</p>
				<div class="itemizedlist">
					<ul type="disc">
						<li>
							<p>"foldflag" + i 表示第 i 个分区（或者 select == i 的收藏夹）的数据状态:
							</p>
							<div class="itemizedlist">
								<ul type="circle">
									<li>
										<p>0: 当前还没有任何版面数据。</p>
									</li>
									<li>
										<p>1: 当前有折叠版面列表所必需的所有数据。</p>
									</li>
									<li>
										<p>2: 当前已经有所有用作显示的版面数据了。</p>
									</li>
								</ul>
							</div>
							<p>
							</p>
						</li>
						<li>
							<p>"curfold" + i 表示第 i 个分区（或者 select == i 的收藏夹）的折叠状态:
							</p>
							<div class="itemizedlist">
								<ul type="circle">
									<li>
										<p>0: 隐藏。</p>
									</li>
									<li>
										<p>1: 折叠版面列表。</p>
									</li>
									<li>
										<p>2: 详细版面列表。</p>
									</li>
								</ul>
							</div>
							<p>
							</p>
						</li>
					</ul>
				</div>
			</div>
			<div class="section" lang="zh-cn">
				<div class="titlepage">
					<div>
						<div>
							<h3 class="title">
								<a name="funcs_php"></a>3.5.&#160;inc/funcs.php 代码分析
							</h3>
						</div>
					</div>
				</div>
				<div class="orderedlist">
					<ol type="1">
						<li>
							<p>可引用的全局变量。这些变量在 include 之后生效
							</p>
							<div class="glosslist">
								<dl>
									<dt>$loginok</dt>
									<dd>
										<p>是否以正式用户登录了，guest 登录的话为 0。</p>
									</dd>
									<dt>$guestloginok</dt>
									<dd>
										<p>当前是否以 guest 身份登录了。</p>
									</dd>
									<dt>$currentuser</dt>
									<dd>
										<p>当前用户信息的数组，请注意 (!$loginok &amp;&amp; !$guestloginok) 情况下该变量无效。该数组的元素请参考
											phpbbslib.c 内 assign_user() 函数。</p>
									</dd>
									<dt>$currentuinfo</dt>
									<dd>
										<p>当前用户附加信息的数组，请注意 (!$loginok &amp;&amp; !$guestloginok) 情况下该变量无效。该数组的元素请参考
											phpbbslib.c 内 assign_userinfo() 函数。</p>
									</dd>
								</dl>
							</div>
							<p>
							</p>
						</li>
						<li>
							<p>可设置的全局变量。必须在 include 之前设置
							</p>
							<div class="glosslist">
								<dl>
									<dt>$setboard</dt>
									<dd>
										<p>赋值成 1 的时候将设置当前用户不在任何版面上。web 由于用户可以开多个窗口，所以如果任何和版面无关的页面都将这个设置成 1
											反而会导致统计更不准确并且加重系统负担。目前只有首页和讨论区列表将其设置为 1。</p>
									</dd>
									<dt>$needlogin</dt>
									<dd>
										<p>这个变量不建议设置。当设置为 0 时，如果当前用户没有登录（注意 guest 登录也算作用户登录），则不主动登录为 guest，同时也不设置登录信息的
											cookie。这样做如果用户没有登录 (!$loginok &amp;&amp; !$guestloginok)
											必须特别注意，该脚本内后续的操作必须和登录用户完全没有关系，而且绝不能假设当前登录用户是 guest，包括 php 库函数内，因为这种情况下
											getCurrentUser() 可能是 NULL！例如，rss.php 设置 $needlogin = 0，这样直接调用
											bbs_getarticles() 函数就是有问题的，因为这个函数内部要根据当前登录用户来产生帖子标记。现在 rss.php
											采用的办法是如果当前没有用户登录就调用一下 bbs_setguest_nologin() 虚设当前用户为非登录状态的 guest。注意，即使调用了
											bbs_setguest_nologin() 函数，PHP 变量 $currentuser
											仍旧是无效的！一句话，除非你完全确定你在干什么（特别安全方面已经考虑周全），否则不要将 $needlogin 设置为 0，也不要去调用
											bbs_setguest_nologin()。</p>
									</dd>
								</dl>
							</div>
							<p>
							</p>
						</li>
						<li>
							<p>有用的函数说明</p>
							<div class="glosslist">
								<dl>
									<dt>cache_header($scope,$modifytime=0,$expiretime=300)</dt>
									<dd>
										<p>检查/设置页面 cache。$scope 一般设置成 "public" 以让客户端缓存。如果客户端 cache 内本文件修改时间不早于
											$modifytime，则输出 Not Modified HTTP-状态码，并返回 TRUE；否则输出 cache 控制头，并返回 FALSE。这里
											$modifytime 一般取相应文件的修改时间，比如附件输出的页面调用这个函数，$modifytime 就是附件所属文件的修改时间。</p>
									</dd>
									<dt>update_cache_header($updatetime = 10,$expiretime = 300)</dt>
									<dd>
										<p>检查/设置页面 cache。如果客户端 cache 内文件修改时间是 $updatetime 分钟内的，则输出 Not Modified
											HTTP-状态码，并返回 TRUE；否则输出 cache 控制头，并返回
											FALSE。这个函数一般用于强制客户端缓存一些系统状态信息，以免过多刷新加重服务器负担。</p>
										<div class="note" style="margin-left: 0.5in; margin-right: 0.5in;">
											<h3 class="title">注意</h3>
											<p>这两个 cache 函数对于调试页面是不方便的。在调试阶段可以在 cache_process() 函数的开头写上 return FALSE;
												直接返回。</p>
										</div>
									</dd>
									<dt>setStat($stat)</dt>
									<dd>
										<p>设置页面标题，应该先于 html_init() 或 show_nav() 调用。</p>
									</dd>
									<dt>html_init($charset="",$otherheader="",$is_mathml=false)</dt>
									<dd>
										<p>初始化 html 页面，一般不需要直接调用，除非是小页面。</p>
										<div class="itemizedlist">
											<div class="glosslist">
												<dl>
													<dt>$charset</dt>
													<dd>
														<p>页面编码，默认 gb2312。</p>
													</dd>
													<dt>$otherheader</dt>
													<dd>
														<p>附加放入 &lt;head&gt; 段的内容。</p>
													</dd>
													<dt>$is_mathml</dt>
													<dd>
														<p>本页面是否采用 xhtml+mathml 发送。</p>
													</dd>
												</dl>
											</div>
											<ul type="disc"></ul>
										</div>
									</dd>
									<dt>show_nav($boardName='',$is_mathml=false,$other_headers="")</dt>
									<dd>
										<p>调用 html_init("",$other_headers,$is_mathml) 并显示页面头。如果 $boardName
											不为空，搜索的链接将会自动选中此版面。如果 $boardName 为 false，不显示菜单条。所有 POST 递交生成的页面原则上都应该设置
											$boardName=false，否则用户重新登录，调整页面风格等可能会造成返回后的 URL 不正确。</p>
									</dd>
									<dt>head_var($Title='', $URL='',$showWelcome=0)</dt>
									<dd>
										<p>显示导航条。</p>
									</dd>
									<dt>setSucMsg($msg)</dt>
									<dd>
										<p>添加成功操作信息 $msg。</p>
									</dd>
									<dt>html_success_quit($Desc='',$URL='')</dt>
									<dd>
										<p>显示成功操作信息。</p>
									</dd>
									<dt>requireLoginok($msg = false, $directexit = true)</dt>
									<dd>
										<p>声明本页面必须正式注册用户才能访问。如果当前用户是正式用户，函数直接返回。否则直接调用 foundErr(错误信息, $directexit,
											false)，其中错误信息由 $msg 控制：</p>
										<div class="itemizedlist">
											<div class="glosslist">
												<dl>
													<dt>$msg</dt>
													<dd>
														<p>错误信息。如果为 false 就是用默认的错误信息。</p>
													</dd>
												</dl>
											</div>
											<ul type="disc"></ul>
										</div>
										<p>这个函数还有一个作用是，调用它之后调用 show_nav() 显示的页面头里面的注销 link
											将会带到首页，否则注销仍旧会回到当前页面。页面调用这几个函数的顺序应该是：setStat, requireLoginok, show_nav。</p>
									</dd>
									<dt>foundErr($msg, $directexit = true, $showmsg = true)</dt>
									<dd>
										<p>添加操作错误信息 $msg。$directexit 为 true 时，调用 show_footer($showmsg, true)
											并结束页面，如果之前还没有显示过页面头，这个函数会自动调用 show_nav() 显示页面头。</p>
										<div class="warning" style="margin-left: 0.5in; margin-right: 0.5in;">
											<h3 class="title">警告</h3>
											<p>当 $directexit 为 true (默认) 的时候，requireLoginok() 和 foundErr()
												两个函数如果碰到错误会结束页面！</p>
										</div>
									</dd>
									<dt>isErrFounded()</dt>
									<dd>
										<p>是否有错误发生。</p>
									</dd>
									<dt>html_error_quit()</dt>
									<dd>
										<p>显示错误信息。如果曾经调用过 requireLoginok() 而当前用户又是 guest，将会显示登录框。这个函数一般不需要直接调用。</p>
									</dd>
									<dt>show_footer($showmsg = true, $showerr = true)</dt>
									<dd>
										<p>显示页面最后的版权信息等。参数：</p>
										<div class="glosslist">
											<dl>
												<dt>$showmsg</dt>
												<dd>
													<p>指示本页面是否有自动刷新消息接受页面的功能。除非是小页面，一般都设置成 true。</p>
												</dd>
												<dt>$showerr</dt>
												<dd>
													<p>如果页面有错误，是否调用 html_error_quit() 输出错误信息。</p>
												</dd>
											</dl>
										</div>
									</dd>
									<dt>jumpReferer()</dt>
									<dd>
										<p>如果 Referer 有设置，跳到 Referer，否则跳到首页。</p>
									</dd>
									<dt>get_secname_index($secnum)</dt>
									<dd>
										<p>在 inc/wForum.site.php 里面用 $section_nums 数组定义了分类讨论区代号。这个函数中的 $secnum
											参数是某个分类讨论区的代号（可能会是字母），该函数的返回值是这个分类讨论区在 $section_nums 数组中的位置。在 wForum 和
											phpbbslib.c 程序中，secNum 是一个被混用的变量名，一般从 phpbbslib.c 中出来的 secNum 表示分类讨论区代号；而在
											wForum 页面之间传递的 secNum 参数，又一般是 $section_nums 数组元素的下标。在 wForum
											的后续开发中，这个问题需要特别注意。</p>
									</dd>
								</dl>
							</div>
						</li>
					</ol>
				</div>
			</div>
			<div class="section" lang="zh-cn">
				<div class="titlepage">
					<div>
						<div>
							<h3 class="title">
								<a name="itex2mathml_details"></a>3.6.&#160;itex2mathml 的一些技术细节
							</h3>
						</div>
					</div>
				</div>
				<p>Mozilla 等通过服务器发送的 Content-Type 来判断文档类型，只有 xml 才会得到 Mathml 支持。而 IE 的 MathPlayer 插件也可以依赖于 Content-Type
					来判断是否需要 MathPlayer 的预处理，所以碰到带有 tex 的帖子，服务器会自动发送 application/xhtml+xml 的 Content-Type。另外，如果 IE 没有装
					MathPlayer 插件，用这个 Content-Type 会造成 xml parse 错误，所以如果 User-Agent 表明客户端是一个没有安装 MathPlayer 的
					IE，还是会使用普通的 text/html Content-Type。这是唯一需要判断浏览器类型的地方，具体的代码可以在 inc/funcs.php 的 html_init()
					函数内找到。请注意，程序假设客户端如果不是 IE 就必定支持 Mathml，如果客户端是比较古老的浏览器是有问题的，请站点管理员对最终用户说明。</p>
				<p>由于 Mathml 必须使用 xml 文档标准，而 xml 对页面 tag 的要求极为严格，所以需要使用 application/xhtml+xml Content-Type 的文件，html
					的书写必须按照 xhtml 的标准非常规范的书写。目前可能使用 application/xhtml+xml Content-Type 的页面只有 disparticle.php 和
					preview.php，所有与这两个页面相关的 html 已经按照 xhtml 标准改写，但是其它页面还远远没有达到 xhtml 的规范，wForum 今后的开发必须要避免不规范的 xhtml 写法。
				</p>
				<p>不规范的 xml 文档在 Mozilla 里面会出 parse 错误，所以这必须严格避免。为此，一旦帖子使用 tex 发表，就禁用除 [upload=1][/upload] 上传文件 ubb 以外的所有
					ubb 功能。另外，在两个 $ 之间或者 \[ 和 \] 之间是 itex 公式，这个公式区域内所有的 ansi
					颜色格式等（包括引文变色）也失效。目前这部分可能还有一些问题，可能还可以通过一些办法使浏览器出错导致不能阅读帖子，请发现问题提交 bug 报告。</p>
			</div>
			<div class="section" lang="zh-cn">
				<div class="titlepage">
					<div>
						<div>
							<h3 class="title">
								<a name="browscap"></a>3.7.&#160;USEBROWSCAP 站点参数（这个功能目前关闭）
							</h3>
						</div>
					</div>
				</div>
				<p>开启 USEBROWSCAP 站点参数就会使用 browscap() 函数来更准确地判断浏览器和操作系统类型，需要配置 PHP 的
					browscap.ini。默认关闭这个功能。开启这个功能虽然会准确判断出非 IE 浏览器，但是会大大降低出首页的速度，参考：<a
						href="http://www.php.net/manual/en/function.get-browser.php" target="_blank">get_browser()
						函数文档</a> 中 verx at implix dot com 添加的用户注释。</p>
			</div>
			<div class="section" lang="zh-cn">
				<div class="titlepage">
					<div>
						<div>
							<h3 class="title">
								<a name="bbsleft"></a>3.8.&#160;wForum 框架结构支持
							</h3>
						</div>
					</div>
				</div>
				<p>wForum 支持类似 kbsbbs 系统 web 界面的框架结构，也就是左边有一个树状功能目录。要实现这个只要从 wForum/frames.php
					进入即可。目前这个支持只是实现功能，左边的功能目录并不漂亮。另外，有一个 bug
					是当用户收藏版面发生变化的时候左边的功能目录不会自动刷新，没有加这个的原因是希望在这种情况下不要刷新整个页面，而只是刷新收藏夹那棵树，这个日后会完善。</p>
			</div>
			<div class="section" lang="zh-cn">
				<div class="titlepage">
					<div>
						<div>
							<h3 class="title">
								<a name="misc"></a>3.9.&#160;一些杂事
							</h3>
						</div>
					</div>
				</div>
				<div class="itemizedlist">
					<ul type="disc">
						<li>
							<p>一个主题，如果最后一个回复是未读的，自动认为这个主题未读。</p>
						</li>
						<li>
							<p>版面搜索功能只搜索楼主，时间范围指定的是最后回复时间范围。</p>
						</li>
						<li>
							<p>queryresult.php 使用 javascript 来写页面。如果搜索结果过多，可能会提示是否取消 javascript 运行。另外搜索结果全都放在一 table
								里面，如果页面没有下完，就什么都不会显示。这些暂时不管了吧，以后搜索做成分页的就好了。</p>
						</li>
						<li>
							<p>目前使用 php session 的只有注册页的图片识别。register.php 和 img_rand/img_rand.php 自己调用 session_start(),
								inc/funcs.php 不调用 session_start()。这个以后有必要的话可以改。比方浏览器 cookie 标准是有个数上限的，可以考虑把 cookie 全都放到
								session 里面。当然那样的话 php session_tmp 那个目录要弄成 tmpfs。另外需要注意新的 php 版本，session_start() 不能被调用两次。
							</p>
						</li>
					</ul>
				</div>
			</div>
		</div>
	</div>
</body>

</html>